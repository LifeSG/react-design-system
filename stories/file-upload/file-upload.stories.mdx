import { Canvas, Meta, Story } from "@storybook/addon-docs";
import { useEffect, useState } from "react";
import {
    Heading3,
    Heading4,
    PreviewBox,
    Secondary,
    StoryContainer,
    Title,
} from "../storybook-common";
import { FileUpload } from "src/file-upload";
import { SimpleIdGenerator } from "src/util/simple-id-generator";

<Meta title="Modules/FileUpload" component={FileUpload} />

<Title>FileUpload</Title>

<Secondary>Overview</Secondary>

A component that allows for uploading files.

```tsx
import { FileUpload } from "@lifesg/react-design-system/file-upload";
```

<Canvas>
    <Story name="FileUpload">
        {() => {
            const [fileItems, setFileItems] = useState([]);
            const handleChange = (files) => {
                const newFileItems = files.map((file) => {
                    return {
                        id: SimpleIdGenerator.generate(),
                        name: file.name,
                        size: file.size,
                        type: file.type,
                    };
                });
                setFileItems((prevItems) => {
                    return prevItems.concat(newFileItems);
                });
            };
            const handleDelete = (fileItem) => {
                const newArr = [...fileItems];
                newArr.splice(newArr.indexOf(fileItem), 1);
                setFileItems(newArr);
            };
            return (
                <FileUpload
                    fileItems={fileItems}
                    onChange={handleChange}
                    onDelete={handleDelete}
                    title="Content title"
                    description="Additional description for the user to consider when uploading their files."
                    warning={
                        <>
                            Maximum size per file: 2 MB
                            <br />
                            Supported file types: .JPG, .JPEG, .PNG
                        </>
                    }
                />
            );
        }}
    </Story>
</Canvas>

<Heading3>Error display</Heading3>

Each file item comes with an error display to indicate that the upload has failed.

<Canvas>
    <Story name="With error display">
        {() => {
            const [fileItems, setFileItems] = useState([]);
            const handleChange = (files) => {
                const newFileItems = files.map((file) => {
                    return {
                        id: SimpleIdGenerator.generate(),
                        name: file.name,
                        size: file.size,
                        type: file.type,
                        errorMessage: "Something went wrong",
                    };
                });
                setFileItems((prevItems) => {
                    return prevItems.concat(newFileItems);
                });
            };
            const handleDelete = (fileItem) => {
                const newArr = [...fileItems];
                newArr.splice(newArr.indexOf(fileItem), 1);
                setFileItems(newArr);
            };
            return (
                <FileUpload
                    fileItems={fileItems}
                    onChange={handleChange}
                    onDelete={handleDelete}
                    title="Content title"
                    description="Additional description for the user to consider when uploading their files."
                    warning={
                        <>
                            Maximum size per file: 2 MB
                            <br />
                            Supported file types: .JPG, .JPEG, .PNG
                        </>
                    }
                />
            );
        }}
    </Story>
</Canvas>

<Heading3>Loading indicator</Heading3>

The component also has the ability to render a loading indicator for file
uploads. However this will require the user to manage the progress themselves.

> The source code implementation is meant for simulation purposes and should
> not be used entirely as reference for the exact implementation

<Canvas>
    <Story name="With loading indicator">
        {() => {
            const [fileItems, setFileItems] = useState([]);
            useEffect(() => {
                if (fileItems.length > 0) {
                    updateProgress();
                }
            }, [fileItems]);
            const handleChange = (files) => {
                const newFileItems = files.map((file) => {
                    return {
                        id: SimpleIdGenerator.generate(),
                        name: file.name,
                        size: file.size,
                        type: file.type,
                        progress: 0,
                    };
                });
                setFileItems((prevItems) => {
                    return prevItems.concat(newFileItems);
                });
            };
            const handleDelete = (fileItem) => {
                const newArr = [...fileItems];
                newArr.splice(newArr.indexOf(fileItem), 1);
                setFileItems(newArr);
            };
            const updateProgress = () => {
                const hasInProgressItems = fileItems.some(
                    (item) => item.progress < 1
                );
                if (hasInProgressItems) {
                    const updatedFileItems = fileItems.map((item) => {
                        let newProgress;
                        if (item.progress === 1) {
                            newProgress = undefined;
                        } else if (item.progress < 1) {
                            newProgress = item.progress + 0.25;
                        }
                        return {
                            ...item,
                            progress: newProgress,
                        };
                    });
                    setTimeout(() => {
                        setFileItems(updatedFileItems);
                    }, 200);
                }
            };
            return (
                <FileUpload
                    fileItems={fileItems}
                    onChange={handleChange}
                    onDelete={handleDelete}
                    title="Content title"
                    description="Additional description for the user to consider when uploading their files."
                    warning={
                        <>
                            Maximum size per file: 2 MB
                            <br />
                            Supported file types: .JPG, .JPEG, .PNG
                        </>
                    }
                />
            );
        }}
    </Story>
</Canvas>

<Secondary>Component API</Secondary>

To be added at the end
